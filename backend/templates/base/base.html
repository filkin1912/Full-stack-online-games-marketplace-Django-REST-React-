{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'styles/style.css' %}">
    <title>GamesPlay</title>
</head>
<body>
<div id="box">

    <!-- Header -->
    <header>
        <div class="header-left">
            <h1><a class="home" href="{% url 'index' %}">All Games</a></h1>

            <!-- Search bar ALWAYS present for consistent layout -->
            <form id="search-form" class="search-bar" method="get" action=""
                  {% if request.resolver_match.url_name != 'index' %}
                      style="visibility:hidden; height:0; margin:0; padding:0;"
                  {% endif %}>
                <input type="text" name="q" placeholder="Search game" class="search-input">
                <button type="submit" class="search-btn">GO</button>
            </form>
        </div>

        <nav>
            {% if request.user.is_authenticated %}
                <a href="{% url 'load games' %}" class="nav-bnt">Load games</a>
                <a href="{% url 'seed games' %}" class="nav-bnt">Seed games</a>
                <a href="{% url 'profile logout' %}" class="nav-btn">LogOut</a>
                <a href="{% url 'bought games' %}" class="nav-btn">Bought games</a>
                <a href="{% url 'my games' pk=request.user.pk %}" class="nav-btn">My games</a>
                <a href="{% url 'game create' %}" class="nav-btn">Create Game</a>
                <a href="{% url 'profile details' pk=request.user.pk %}" class="nav-btn">Profile</a>
            {% else %}
                <a href="{% url 'profile login' %}" class="nav-btn">LogIn</a>
                <a href="{% url 'profile create' %}" class="nav-btn">Create Profile</a>
            {% endif %}
        </nav>
    </header>

    <!-- Page Controls -->
    {% if show_controls %}
        <div class="controls-row">
            <form method="get" class="sort-form">
                {% if search_query %}
                    <input type="hidden" name="q" value="{{ search_query }}">
                {% endif %}
                {% if per_page %}
                    <input type="hidden" name="per_page" value="{{ per_page }}">
                {% endif %}
                <label for="sort">Sort by:</label>
                <select name="sort" onchange="this.form.submit()">
                    <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest</option>
                    <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>Oldest</option>
                    <option value="price" {% if sort == 'price' %}selected{% endif %}>Price</option>
                </select>
            </form>

            <form method="get" class="per-page-form">
                {% if search_query %}
                    <input type="hidden" name="q" value="{{ search_query }}">
                {% endif %}
                {% if sort %}
                    <input type="hidden" name="sort" value="{{ sort }}">
                {% endif %}
                <label for="per_page">Show per page:</label>
                <select name="per_page" onchange="this.form.submit()">
                    {% for option in per_page_options %}
                        <option value="{{ option }}" {% if per_page == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>

        <div class="fixed-paginator">
            <span class="page-range">
                {{ page_obj.start_index }} – {{ page_obj.end_index }} of {{ page_obj.paginator.count }}
            </span>
            <div class="page-controls">

                {% if page_obj.has_previous %}
                    <a href="?page=1{% if search_query %}&q={{ search_query }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="page-btn">&laquo;</a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="page-btn">&lsaquo;</a>
                {% else %}
                    <span class="page-btn disabled">&laquo;</span>
                    <span class="page-btn disabled">&lsaquo;</span>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
                        {% if page_obj.number == num %}
                            <span class="page-btn current">{{ num }}</span>
                        {% else %}
                            <a href="?page={{ num }}{% if search_query %}&q={{ search_query }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="page-btn">{{ num }}</a>
                        {% endif %}
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="page-btn">&rsaquo;</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&q={{ search_query }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="page-btn">&raquo;</a>
                {% else %}
                    <span class="page-btn disabled">&rsaquo;</span>
                    <span class="page-btn disabled">&raquo;</span>
                {% endif %}
            </div>
        </div>
    {% endif %}

    {% block content %}
    {% endblock %}

    <!-- Messages -->
    {% if messages %}
        <div class="message-overlay">
            <div class="message-container">
                {% for message in messages %}
                    <div class="custom-message {{ message.tags }}">
                        <span class="message-text">{{ message }}</span>
                        <button class="close-button" onclick="this.parentElement.style.display='none';">&times;</button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- Footer -->
    {% if request.user.is_authenticated %}
        <footer>
            <p>
                Welcome,
                {% if profile_user.display_name %}
                    {{ profile_user.display_name }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                {% else %}
                    {{ profile_user.email }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                {% endif %}
            </p>
            <p class="profile-balance-box">
                Balance:&nbsp;${{ profile_money|floatformat:2 }}
            </p>
        </footer>
    {% else %}
        <footer>
            <p>©Vasil Filkin 2025</p>
        </footer>
    {% endif %}
</div>

<!-- Auto-dismiss messages -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const messages = document.querySelectorAll(".custom-message");

        setTimeout(() => {
            messages.forEach(msg => {
                msg.classList.add("fade-out");
                setTimeout(() => msg.style.display = "none", 500);
            });
        }, 2000);
    });
</script>

</body>
</html>
